<p-dialog header="Asignar Institución" [(visible)]="dialogForm" [maximizable]="true" [modal]="true">
  <app-assignment *ngIf="dialogForm" [tests]="selectedTests"></app-assignment>
</p-dialog>

<div class="container">
  <p-toolbar>
    <div class="p-toolbar-group-left">
      <div *ngIf="!selectedTests?.length">
        <p-button label="ALTA" icon="pi pi-exclamation-circle" styleClass="p-button-danger mr-2"
                  badge="28"></p-button>
        <p-button label="MEDIA Amarillo" icon="pi pi-exclamation-triangle" styleClass="p-button-warning mr-2"
                  badge="15"></p-button>
        <p-button label="BAJA" icon="pi pi-thumbs-up" styleClass="p-button-success mr-2" badge="10"></p-button>

        <button pButton pRipple type="button" label="Refrescar"
                class="p-button-info" icon="pi pi-sync"
                (click)="loadTests(paginator.current_page)"></button>
      </div>
      <button *ngIf="selectedTests?.length" pButton pRipple type="button" label="Eliminar seleccionados"
              class="p-button-danger mr-2" icon="pi pi-trash"
              (click)="deleteTests()"></button>
      <button *ngIf="selectedTests?.length" pButton pRipple type="button" label="Asignar Tests" icon="pi pi-share-alt"
              (click)="assignmentForms()"></button>
      <app-progress-bar *ngIf="progressBarDelete" [message]="messageService.progressBarDelete"
                        class="ml-2"></app-progress-bar>
    </div>
    <div class="p-toolbar-group-right">
      <p-dropdown [options]="states" optionLabel="name"></p-dropdown>
      <div class="p-inputgroup ml-2">
        <input pInputText id="search" [formControl]="search" (keypress)="filter($event)">
        <button pButton pRipple type="button" icon="pi pi-search" (click)="filter($event)"></button>
      </div>
    </div>
  </p-toolbar>
  <p-card>
    <p-paginator [rows]="paginator.per_page!"
                 [totalRecords]="paginator.total!"
                 (onPageChange)="paginate($event)"></p-paginator>
    <p-table *appRolesPermissions="['permission:view-users']"
             dataKey="id"
             [value]="(tests$|async)?.data"
             [columns]="cols"
             styleClass="p-datatable-striped"
             [lazy]="true"
             [loading]="(loaded$|async)!"
             [(selection)]="selectedTests"
             [responsive]="true">
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th *ngFor="let col of columns" [pSortableColumn]="col.field">
            {{col.header}}
            <p-sortIcon [field]="col.field"></p-sortIcon>
          </th>
          <th style="text-align: center">
            <button pButton pRipple type="button" class="p-button-rounded p-button-help" icon="pi pi-cog"></button>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
        <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
          <td>
            <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
          </td>
          <td *ngFor="let col of columns">
            <span *ngIf="rowData[col.field]?.id" [ngSwitch]="col.field">
               <span *ngSwitchCase="'assignment'">
                {{rowData[col.field].institution.shortName}}
              </span>
              <span *ngSwitchCase="'priority'">
                <button pButton type="button"
                        [label]="rowData[col.field].name"
                        icon="pi pi-exclamation-circle"
                        [ngClass]="{
                        'p-button-danger':rowData[col.field].level===1,
                        'p-button-warning':rowData[col.field].level===2,
                        'p-button-success':rowData[col.field].level===3
                        }"
                ></button>
              </span>
              <span *ngSwitchCase="'state'">
                {{rowData[col.field].name}}
              </span>
              <span *ngSwitchCase="'user'">
                {{rowData[col.field].username}}
                {{rowData[col.field].name}}
                {{rowData[col.field].lastname}}
              </span>
            </span>
            <span *ngIf="!rowData[col.field]?.id" [ngSwitch]="col.field">
              <span *ngSwitchCase="'updatedAt'">{{rowData[col.field]|date}}</span>
              <span *ngSwitchCase="'createdAt'">{{rowData[col.field]|date}}</span>
              <span *ngSwitchDefault>{{rowData[col.field]}}</span>
              <!--              <span *ngSwitchCase="'certificated'">{{rowData[col.field]|certificated}}</span>-->
            </span>
          </td>
          <td style="text-align: center">
            <p-splitButton label="Más" styleClass="" icon="pi pi-bars"
                           (onClick)="assignmentForm()"
                           (onDropdownClick)="selectTest(rowData)"
                           [model]="items"></p-splitButton>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="summary">
        {{messageService.paginatorTotalRegisters(paginator)}}
      </ng-template>
      <ng-template pTemplate="emptymessage" let-columns>
        <tr>
          <td [attr.colspan]="columns.length">
            {{messageService.paginatorNoRecordsFound}}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
